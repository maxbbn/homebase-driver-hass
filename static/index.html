<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="stylesheet" href="//s.rokidcdn.com/homebase/upload/rJ_Hu5JrS.css" />
  <script src="https://unpkg.com/home-assistant-js-websocket@3.0.0/dist/haws.umd.js"></script>
  <title>HASS login</title>
  <style>
    #fgPass {
      display: none
    }
    #fgLongToken {
      display: none
    }
    .type-longLiveToken #fgLongToken {
        display: block
    }
    .type-password #fgPass{
        display: block
    }
  </style>

</head>

<body>
  <div class="container">
    <form class="needs-validation" novalidate>
      <h1>HASS 绑定</h1>
      <div class="form-group">
        <label for="url">HASS URL</label>
        <input type="url" class="form-control" id="url" required aria-describedby="emailHelp"
          placeholder="输入你的 Hass 接口访问地址">
        <small id="emailHelp" class="form-text text-muted">HASS访问地址</small>
      </div>
      <div id="authTypeToggle" class="form-group mb-2" role="group" data-toggle="buttons" aria-label="Basic example">
        <label class="d-block">
          <input type="radio" name="authType" id="radioPassword" value="password" autocomplete="off" checked> 使用密码
        </label>
        <label class="d-block">
          <input type="radio" name="authType" id="radioLongLivedToken" value="longLiveToken" autocomplete="off"> 使用长期访问令牌
        </label>
      </div>
      <div class="form-group" id="fgLongToken">
        <input type="text" class="form-control" id="inputLongLivetoken" placeholder="输入长期访问令牌">
      </div>
      <div class="form-group" id="fgPass">
        <input type="text" class="form-control" id="inputPassword" placeholder="输入访问密码">
      </div>
      <div class="form-group">
        <button type="submit" class="btn btn-primary">去绑定</button>
      </div>

    </form>
  </div>
  <script>
    (function () {
      'use strict';
      window.addEventListener('load', function () {
        const radios = document.querySelectorAll('input[name="authType"][type=radio]')
        const theForm = document.querySelector('form')
        const elUrl = document.querySelector('#url')
        var authType

        radios.forEach(el => {
          el.parentElement.addEventListener('click', function (ev) {
            setTimeout(function () {
              updateValidate()
            }, 100)
          })
        })
        
        function updateValidate() {
          let otherTypes = []
          radios.forEach(elem => {
            if (elem.checked) {
              authType = elem.value
            } else {
              otherTypes.push(elem.value)
            }
          })
          
          theForm.classList.add('type-' + authType)
          otherTypes.forEach(type => {
            theForm.classList.remove('type-' + type)
          })

          if (authType === 'password') {
            document.querySelector('#fgPass').classList.remove('d-none')
            document.querySelector('#fgPass input').required = true
          } else {
            document.querySelector('#fgPass').classList.add('d-none')
            document.querySelector('#fgPass input').required = false
          }
        }

        updateValidate()
        const hassURL = localStorage.getItem('hassURL')
        if (hassURL) {
          elUrl.value = hassURL
        }
        
        function errorAuth(err) {
          console.error('errorAuth', err)
        }

        const query = location.search.substr(1).split('&').reduce(function (o, pair) {
          const p = pair.split('=')
          if (p.length) {
            o[p[0]] = p[1] ? decodeURIComponent(p[1]) : undefined
          }
          return o
        }, {})

        const options = {}

        function callback(authObj, callbackURL) {
          if (!callbackURL) {
            callbackURL = localStorage.getItem('redirect')
          }
          if (!callbackURL) {
            alert('参数不全： no callback url')
            return
          }
          var isOAuth2 = authObj.type === 'oauth2'

          var objQuery = {
            userId: 'hass-' + authObj.type,
            userToken: '',
            expiresIn: '',
            refreshToken: '',
            ext1: authObj.hassUrl,
            ext2: '',
            ext3: authObj.type
          }
          switch (authObj.type) {
              case 'oauth2':
                objQuery.userToken = authObj.access_token
                objQuery.expiresIn = authObj.expires_in
                objQuery.refreshToken = authObj.refresh_token
                objQuery.ext2 = authObj.clientId
                break;
            case 'password': 
              objQuery.userToken = authObj.password
              break;
            case 'longLiveToken':
              objQuery.userToken = authObj.longLiveToken
              break;
          }
          var search = Object.keys(objQuery).reduce((s, key) => {
            s && (s += '&');
            s += [key, encodeURIComponent(objQuery[key])].join('=')
            return s
          }, '')
          location.href = callbackURL + (/\?/.test(callbackURL) ? '&' : '?') + search
        }

        function useAuth(auth) {
          history.replaceState(null, null, "/");
          callback(Object.assign(auth.data, {
            type: 'oauth2'
          }))
        }

        HAWS.getAuth(options)
          .then(useAuth, errorAuth)

        theForm.addEventListener('submit', function (event) {
          event.preventDefault();
          event.stopPropagation();
          theForm.classList.add('was-validated');
          var hassUrl = elUrl.value;
          localStorage.setItem('hassURL', hassUrl)
          if (theForm.checkValidity() === false) {
            alert('not valid')
          } else {
            const url = location.search
            if (authType === 'token') {
              var options = { hassUrl: hassUrl };
              if (hassUrl.substr(0, 5) == 'http:') {
                options.gitredirectUrl = "http://" + location.host + location.pathname
                options.redirectUrl = options.redirectUrl
              }
              localStorage.setItem('redirect', query.callbackURL)
              HAWS.getAuth(options)
                .then(useAuth, errorAuth);
            } else if (authType === 'password') {
              callback({
                type: 'password',
                hassUrl: hassUrl,
                password: document.querySelector('#inputPassword').value
              }, query.callbackURL)
            } else if (authType === 'longLiveToken') {
              callback({
                type: 'longLiveToken',
                hassUrl: hassUrl,
                longLiveToken: document.querySelector('#inputLongLivetoken').value
              }, query.callbackURL)
            }
          }
        }, false);
      }, false);
    })()
  </script>
</body>

</html>  